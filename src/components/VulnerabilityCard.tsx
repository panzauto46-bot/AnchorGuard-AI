import { useState } from 'react';
import { useTheme } from '../context/ThemeContext';
import { ChevronDown, ChevronUp, Copy, Check, AlertTriangle, AlertCircle, Info, ShieldCheck, Zap } from 'lucide-react';
import type { Vulnerability } from '../types';

interface VulnerabilityCardProps {
  vuln: Vulnerability;
  index: number;
}

export function VulnerabilityCard({ vuln, index }: VulnerabilityCardProps) {
  const { isDark } = useTheme();
  const [expanded, setExpanded] = useState(false);
  const [copiedFix, setCopiedFix] = useState(false);

  const handleCopyFix = () => {
    navigator.clipboard.writeText(vuln.fixedCode);
    setCopiedFix(true);
    setTimeout(() => setCopiedFix(false), 2000);
  };

  const severityConfig = {
    critical: {
      label: 'CRITICAL',
      color: isDark ? 'text-red-400' : 'text-red-600',
      bg: isDark ? 'bg-red-500/10 border-red-500/20' : 'bg-red-50 border-red-200',
      badge: isDark ? 'bg-red-500/20 text-red-400' : 'bg-red-100 text-red-700',
      icon: <AlertCircle className="w-4 h-4" />,
      accent: isDark ? 'border-l-red-500' : 'border-l-red-400',
    },
    high: {
      label: 'HIGH',
      color: isDark ? 'text-orange-400' : 'text-orange-600',
      bg: isDark ? 'bg-orange-500/10 border-orange-500/20' : 'bg-orange-50 border-orange-200',
      badge: isDark ? 'bg-orange-500/20 text-orange-400' : 'bg-orange-100 text-orange-700',
      icon: <AlertTriangle className="w-4 h-4" />,
      accent: isDark ? 'border-l-orange-500' : 'border-l-orange-400',
    },
    medium: {
      label: 'MEDIUM',
      color: isDark ? 'text-yellow-400' : 'text-yellow-600',
      bg: isDark ? 'bg-yellow-500/10 border-yellow-500/20' : 'bg-yellow-50 border-yellow-200',
      badge: isDark ? 'bg-yellow-500/20 text-yellow-400' : 'bg-yellow-100 text-yellow-700',
      icon: <Info className="w-4 h-4" />,
      accent: isDark ? 'border-l-yellow-500' : 'border-l-yellow-400',
    },
    safe: {
      label: 'SAFE',
      color: isDark ? 'text-green-400' : 'text-green-600',
      bg: isDark ? 'bg-green-500/10 border-green-500/20' : 'bg-green-50 border-green-200',
      badge: isDark ? 'bg-green-500/20 text-green-400' : 'bg-green-100 text-green-700',
      icon: <ShieldCheck className="w-4 h-4" />,
      accent: isDark ? 'border-l-green-500' : 'border-l-green-400',
    },
  };

  const config = severityConfig[vuln.severity];

  return (
    <div
      className={`rounded-xl border border-l-4 ${config.bg} ${config.accent} overflow-hidden transition-all`}
      style={{ animation: `slideIn 0.4s ease-out ${index * 0.1}s both` }}
    >
      {/* Card Header */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full flex items-center gap-3 px-4 py-3 text-left"
      >
        <span className={config.color}>{config.icon}</span>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap">
            <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${config.badge}`}>
              {config.label}
            </span>
            <span className={`text-xs ${isDark ? 'text-zinc-500' : 'text-zinc-400'}`}>
              Line {vuln.line}
            </span>
            <span className={`text-[10px] px-1.5 py-0.5 rounded ${isDark ? 'bg-white/5 text-zinc-500' : 'bg-zinc-100 text-zinc-500'}`}>
              {vuln.category}
            </span>
          </div>
          <h3 className={`text-sm font-semibold mt-1 ${isDark ? 'text-white' : 'text-zinc-900'}`}>
            {vuln.title}
          </h3>
          <p className={`text-xs mt-0.5 line-clamp-2 ${isDark ? 'text-zinc-400' : 'text-zinc-500'}`}>
            {vuln.description}
          </p>
        </div>
        {expanded ? (
          <ChevronUp className={`w-4 h-4 shrink-0 ${isDark ? 'text-zinc-500' : 'text-zinc-400'}`} />
        ) : (
          <ChevronDown className={`w-4 h-4 shrink-0 ${isDark ? 'text-zinc-500' : 'text-zinc-400'}`} />
        )}
      </button>

      {/* Expanded Content */}
      {expanded && (
        <div className={`border-t ${isDark ? 'border-white/5' : 'border-zinc-200/50'} px-4 py-4 space-y-4`}>
          {/* Diff Viewer */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
            {/* Original Code */}
            <div>
              <div className={`flex items-center gap-2 mb-2 text-xs font-medium ${isDark ? 'text-red-400' : 'text-red-600'}`}>
                <span className="w-3 h-3 rounded-full bg-red-500/20 flex items-center justify-center text-[8px]">âœ•</span>
                Vulnerable Code
              </div>
              <pre className={`text-[11px] font-mono p-3 rounded-lg overflow-x-auto diff-removed ${isDark ? 'bg-red-500/5 text-zinc-300' : 'bg-red-50 text-zinc-700'}`}>
                <code>{vuln.originalCode}</code>
              </pre>
            </div>

            {/* Fixed Code */}
            <div>
              <div className={`flex items-center justify-between mb-2`}>
                <div className={`flex items-center gap-2 text-xs font-medium ${isDark ? 'text-green-400' : 'text-green-600'}`}>
                  <span className="w-3 h-3 rounded-full bg-green-500/20 flex items-center justify-center text-[8px]">âœ“</span>
                  Fixed Code
                </div>
                <button
                  onClick={handleCopyFix}
                  className={`flex items-center gap-1 text-[10px] px-2 py-1 rounded font-medium transition-all ${
                    isDark
                      ? 'text-solana-green bg-solana-green/10 hover:bg-solana-green/20'
                      : 'text-solana-purple bg-solana-purple/10 hover:bg-solana-purple/20'
                  }`}
                >
                  {copiedFix ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
                  {copiedFix ? 'Copied!' : 'Copy Fix'}
                </button>
              </div>
              <pre className={`text-[11px] font-mono p-3 rounded-lg overflow-x-auto diff-added ${isDark ? 'bg-green-500/5 text-zinc-300' : 'bg-green-50 text-zinc-700'}`}>
                <code>{vuln.fixedCode}</code>
              </pre>
            </div>
          </div>

          {/* Explanation */}
          <div className={`p-3 rounded-lg ${isDark ? 'bg-white/3' : 'bg-zinc-50'}`}>
            <h4 className={`text-xs font-semibold mb-1 ${isDark ? 'text-zinc-300' : 'text-zinc-700'}`}>
              ðŸ’¡ Explanation
            </h4>
            <p className={`text-xs ${isDark ? 'text-zinc-400' : 'text-zinc-500'}`}>
              {vuln.explanation}
            </p>
          </div>

          {/* Compute Impact */}
          {vuln.computeImpact && (
            <div className={`flex items-center gap-2 text-xs ${isDark ? 'text-zinc-500' : 'text-zinc-400'}`}>
              <Zap className="w-3 h-3" />
              <span>Compute Impact: {vuln.computeImpact}</span>
            </div>
          )}
        </div>
      )}

      <style>{`
        @keyframes slideIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
      `}</style>
    </div>
  );
}
